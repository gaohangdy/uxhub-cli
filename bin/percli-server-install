#!/usr/bin/env node
const fs = require('fs')

const { getDistroArtifactList } = require('../lib/DistributionHelper')
const { progressDownload } = require('../lib/Download')
const { startSling } = require('../lib/Server')
const config = require('../config')

async function serverInstall() {

  // step 1 - get list of distribution files and download
  if (!fs.existsSync(config.download.dir)){
    let distroFiles = await getDistroArtifactList()

    console.log('Fetching core distribution')
    for (url of distroFiles.core) {
      await progressDownload(url)
    }

    console.log('Fetching packages')
    for (url of distroFiles.pkgs) {
      await progressDownload(url)
    }
  }

  // step 2 - create sling dir
  if (!fs.existsSync(config.sling.dir)){
    fs.mkdirSync(config.sling.dir)
  }

  // step 3 - start sling
  startSling()

}

if (!fs.existsSync(config.sling.dir)) {
  serverInstall()
} else {
  console.log(`Installation already exists at '${config.sling.dir}'. Exiting.`)
}